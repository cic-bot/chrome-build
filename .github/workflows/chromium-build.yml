name: Build Chromium

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-22.04
    
    steps:
    
      # Step 1: Checkout the repository
      - name: Checkout repository
        uses: actions/checkout@v3

      # Step 2: Set up Python
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'
        
      # Step 3: Install dependencies
      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install -y \
            git \
            python3 \
            python3-pip \
            curl \
            build-essential \
            g++-multilib \
            clang \
            cmake \
            ninja-build \
            libglib2.0-dev
          
      # Step 4: Cache depot_tools
      - name: Cache depot_tools
        id: depot_tools-cache
        uses: actions/cache@v3
        with:
          path: ~/.cache/depot_tools
          key: ${{ runner.os }}-depot_tools-${{ hashFiles('**/depot_tools') }}
          restore-keys: |
            ${{ runner.os }}-depot_tools-

      # Step 5: Clone depot_tools if not found in cache
      - name: Clone depot_tools
        if: steps.depot_tools-cache.outputs.cache-hit != 'true'
        run: |
          git clone https://chromium.googlesource.com/chromium/tools/depot_tools.git ~/.cache/depot_tools
          
      # Step 6: Ensure depot_tools is in PATH
      - name: Ensure depot_tools is in PATH
        run: |
          export DEPOT_TOOLS_PATH="$HOME/.cache/depot_tools"
          export PATH="$DEPOT_TOOLS_PATH:$PATH"
          echo $PATH  # Verify depot_tools is in PATH
          which fetch || echo "fetch command not found"

      # Step 7: Cache Chromium source code directory
      - name: Cache Chromium source code
        id: chromium-cache
        uses: actions/cache@v3
        with:
          path: ~/chromium/src
          key: ${{ runner.os }}-chromium-src-${{ hashFiles('**/chromium/src') }}
          restore-keys: |
            ${{ runner.os }}-chromium-src-

      # Step 8: Fetch Chromium source code if not in cache
      - name: Fetch Chromium source code
        run: |
          export DEPOT_TOOLS_PATH="$HOME/.cache/depot_tools"
          export PATH="$DEPOT_TOOLS_PATH:$PATH"
          mkdir -p ~/chromium && cd ~/chromium
          if [ ! -d "src" ]; then
            fetch --nohooks chromium  # Only fetch if src directory is not found
            gclient sync
          else
            echo "Chromium source already fetched, skipping fetch."
          fi

      # Step 9: Install build dependencies for Chromium
      - name: Install Chromium build dependencies
        run: |
          cd ~/chromium/src
          ./build/install-build-deps.sh

      # Step 10: Generate build files using GN
      - name: Generate build files
        run: |
          cd ~/chromium/src
          gn gen out/Default

      # Step 11: Customize build options (args.gn)
      - name: Set build args
        run: |
          cat <<EOF > ~/chromium/src/out/Default/args.gn
          is_debug = false
          is_component_build = true
          enable_nacl = false
          v8_enable_pointer_compression = false
          blink_symbol_level = 0
          v8_symbol_level = 0
          symbol_level = 0
          EOF

      # Step 12: Build Chromium
      - name: Build Chromium
        run: |
          cd ~/chromium/src
          autoninja -C out/Default chrome

      # Step 13: Verify Chromium build
      - name: Verify Chromium build
        run: |
          cd ~/chromium/src/out/Default
          ./chrome --version
