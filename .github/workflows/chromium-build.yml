name: Build Chromium

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-22.04
    
    steps:
    
      # Step 1: Checkout the repository
      - name: Checkout repository
        uses: actions/checkout@v3

      # Step 2: Set up Python
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'
        
      # Step 3: Install dependencies
      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install -y \
            git \
            python3 \
            python3-pip \
            curl \
            build-essential \
            g++-multilib \
            clang \
            cmake \
            ninja-build \
            libglib2.0-dev
          
      # Step 4: Install depot_tools and update PATH
      - name: Install depot_tools
        run: |
          git clone https://chromium.googlesource.com/chromium/tools/depot_tools.git
          export PATH="$PATH:$(pwd)/depot_tools"  # Directly update PATH in the current shell session
          echo $PATH  # Verify that depot_tools is in the PATH
          # Check if fetch is available
          which fetch || echo "fetch command not found"

      # Step 5: Fetch Chromium source code
      - name: Fetch Chromium source code
        run: |
          export PATH="$PATH:$(pwd)/depot_tools"  # Ensure PATH is set for this step
          mkdir -p chromium && cd chromium
          fetch --nohooks chromium  # This should now work since depot_tools is in PATH
          gclient sync

      # Step 6: Install build dependencies for Chromium
      - name: Install Chromium build dependencies
        run: |
          cd chromium/src
          ./build/install-build-deps.sh

      # Step 7: Generate build files using GN
      - name: Generate build files
        run: |
          cd chromium/src
          gn gen out/Default

      # Step 8: Customize build options (args.gn)
      - name: Set build args
        run: |
          cat <<EOF > chromium/src/out/Default/args.gn
          is_debug = false
          is_component_build = true
          enable_nacl = false
          v8_enable_pointer_compression = false
          blink_symbol_level = 0
          v8_symbol_level = 0
          symbol_level = 0
          EOF

      # Step 9: Build Chromium
      - name: Build Chromium
        run: |
          cd chromium/src
          autoninja -C out/Default chrome

      # Step 10: Verify Chromium build
      - name: Verify Chromium build
        run: |
          cd chromium/src/out/Default
          ./chrome --version
